<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Merger & Splitter — Tool Tap</title>
<link rel="icon" href="favicon_io/favicon-16x16.png" type="image/x-icon">
<!-- pdf-lib from CDN -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
  :root{
    --primary:#1677ff; --dark:#0f5ed7; --bg:#f4f8ff; --card:#ffffff; --muted:#6b7280;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#fff);color:#0b2338}
  .wrap{max-width:980px;margin:28px auto;padding:18px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 12px 40px rgba(12,45,100,0.06);padding:18px;margin-bottom:18px;animation:pop .45s ease}
  @keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
  .brand{background:linear-gradient(90deg,var(--primary),var(--dark));color:#fff;padding:10px 14px;border-radius:10px;font-weight:700}
  h1{margin:0;font-size:1.2rem}
  p.lead{margin:6px 0 0;color:var(--muted);font-size:0.95rem}

  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  /* left column */
  .panel{display:flex;flex-direction:column;gap:12px}
  label.small{font-weight:700;color:var(--muted);font-size:0.95rem}
  input[type=file]{padding:8px;border-radius:10px;border:1px dashed rgba(16,64,160,0.06);background:#fbfdff}
  .file-list{background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(16,64,160,0.04);border-radius:10px;padding:10px;min-height:80px;overflow:auto}
  .file-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;gap:8px}
  .file-item + .file-item{margin-top:6px}
  .file-meta{font-size:0.9rem;color:#0b2338}
  .file-small{font-size:0.84rem;color:var(--muted)}

  .controls{display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:2px solid rgba(22,119,255,0.12)}
  button.warn{background:#ff6b6b}
  .small{font-size:0.92rem;color:var(--muted)}

  /* right column */
  .panel-right{display:flex;flex-direction:column;gap:12px}
  .panel-right .card{padding:12px}
  .section-title{font-weight:800;color:var(--dark);margin-bottom:6px}
  .input-row{display:flex;gap:8px}
  .input-row input[type=number]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefc;background:#fcfeff}
  .input-row .help{font-size:0.85rem;color:var(--muted);align-self:center}

  .result-box{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;border:1px solid rgba(16,64,160,0.04)}
  .status{font-weight:700;color:var(--primary);margin-bottom:6px}
  .log{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0b1220;color:#dfefff;padding:8px;border-radius:8px;max-height:200px;overflow:auto;font-size:13px}

  footer.small{font-size:0.9rem;color:var(--muted);text-align:center;margin-top:8px}

  /* responsive adjustments */
  @media(max-width:520px){
    .brand{display:none}
    .grid{gap:12px}
    .panel-right{order:2}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Tool Tap</div>
      <div>
        <h1>PDF Merger & Splitter</h1>
        <p class="lead">Merge multiple PDFs into one, or split a PDF into pages or custom ranges — all in your browser. Files stay local.</p>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Merger & Splitter controls -->
      <section class="card panel" aria-labelledby="leftTitle">
        <div>
          <div class="section-title" id="leftTitle">1) Upload PDFs</div>
          <div class="small">For merging: select multiple files. For splitting: select a single file.</div>
        </div>

        <div>
          <label class="small">Choose PDF files</label>
          <input id="fileInput" type="file" accept="application/pdf" multiple />
        </div>

        <div>
          <div class="file-list" id="fileList" aria-live="polite">No files yet.</div>
        </div>

        <div>
          <div class="section-title">2) Merge</div>
          <div class="small">Order matters — files are merged in the list order. Drag to reorder? Not yet. Use remove to adjust.</div>
          <div class="controls" style="margin-top:8px">
            <button id="mergeBtn">Merge Selected</button>
            <button id="clearBtn" class="ghost">Clear All</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(16,64,160,0.04);margin:12px 0">

        <div>
          <div class="section-title">3) Split / Extract</div>
          <div class="small">Select one PDF from the list below then choose split options.</div>

          <div style="margin-top:10px" class="input-row">
            <label style="min-width:120px;align-self:center" class="small">Split mode</label>
            <select id="splitMode" style="padding:8px;border-radius:8px;border:1px solid #e6eefc;background:#fcfeff">
              <option value="pages">Split into single pages</option>
              <option value="range">Extract page range</option>
            </select>
          </div>

          <div id="rangeInputs" style="display:none;margin-top:8px" class="input-row">
            <input id="rangeFrom" type="number" min="1" placeholder="From (1)" />
            <input id="rangeTo"   type="number" min="1" placeholder="To" />
          </div>

          <div class="controls" style="margin-top:8px">
            <button id="splitBtn">Split / Extract</button>
            <button id="downloadAllBtn" class="ghost">Download All Generated</button>
          </div>
        </div>

        <div style="margin-top:12px" class="result-box" id="infoBox">
          <div id="status" class="status">Idle</div>
          <div id="infoText" class="small">No actions yet.</div>
        </div>

      </section>

      <!-- RIGHT: Preview + logs -->
      <aside class="panel-right">
        <div class="card">
          <div class="section-title">Uploaded files & preview</div>
          <div class="small">Click a file to select it for splitting. Use remove to discard.</div>
          <div id="previewArea" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div class="section-title">Logs (debug)</div>
          <div class="log" id="logArea">Ready.</div>
        </div>

        <div class="card">
          <div class="section-title">Notes</div>
          <div class="small">Large PDFs may take time; merging/splitting happens in browser memory. Avoid extremely large files on low-memory devices.</div>
        </div>
      </aside>
    </div>

    <footer class="small">Tool Tap • PDF Merger & Splitter — client-side using pdf-lib</footer>
  </div>

<script>
(async () => {
  // pdf-lib available via global PDFLib variable
  const { PDFDocument } = window.PDFLib;
  const fileInput = document.getElementById('fileInput');
  const fileListEl = document.getElementById('fileList');
  const previewArea = document.getElementById('previewArea');
  const logArea = document.getElementById('logArea');
  const mergeBtn = document.getElementById('mergeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const splitBtn = document.getElementById('splitBtn');
  const splitMode = document.getElementById('splitMode');
  const rangeInputs = document.getElementById('rangeInputs');
  const rangeFrom = document.getElementById('rangeFrom');
  const rangeTo = document.getElementById('rangeTo');
  const statusEl = document.getElementById('status');
  const infoText = document.getElementById('infoText');
  const downloadAllBtn = document.getElementById('downloadAllBtn');

  let files = []; // array of {file:File, pages: number, bytes:ArrayBuffer}
  let generatedFiles = []; // results of split (Blobs with filename)

  function log(...args){
    const now = new Date().toLocaleTimeString();
    const line = `${now} — ${args.map(a=> typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' | ')}`;
    logArea.textContent = line + '\n' + logArea.textContent;
    console.log(...args);
  }

  function setStatus(text){
    statusEl.textContent = text;
  }

  function setInfo(text){
    infoText.textContent = text;
  }

  function refreshFileList(){
    fileListEl.innerHTML = '';
    previewArea.innerHTML = '';
    if(files.length === 0){
      fileListEl.textContent = 'No files yet.';
      return;
    }
    files.forEach((fobj, idx) => {
      const row = document.createElement('div');
      row.className = 'file-item';
      const left = document.createElement('div');
      left.style.display = 'flex'; left.style.flexDirection='column';
      const name = document.createElement('div'); name.className='file-meta'; name.textContent = fobj.file.name;
      const meta = document.createElement('div'); meta.className='file-small'; meta.textContent = `${fobj.pages ?? '?'} pages • ${(fobj.file.size/1024/1024).toFixed(2)} MB`;
      left.appendChild(name); left.appendChild(meta);

      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='8px';
      const selectBtn = document.createElement('button'); selectBtn.className='ghost'; selectBtn.textContent='Select';
      const removeBtn = document.createElement('button'); removeBtn.className='ghost'; removeBtn.textContent='Remove';

      selectBtn.addEventListener('click', ()=> selectForSplit(idx));
      removeBtn.addEventListener('click', ()=> {
        files.splice(idx,1); refreshFileList(); setInfo('File removed'); log('Removed file', fobj.file.name);
      });

      right.appendChild(selectBtn); right.appendChild(removeBtn);
      row.appendChild(left); row.appendChild(right);
      fileListEl.appendChild(row);
    });
  }

  async function analyzeFile(file){
    // read bytes and count pages using pdf-lib (loads entire PDF)
    setStatus('Analyzing ' + file.name);
    const ab = await file.arrayBuffer();
    const pdfDoc = await PDFDocument.load(ab);
    const pageCount = pdfDoc.getPageCount();
    return { bytes: ab, pages: pageCount };
  }

  fileInput.addEventListener('change', async (e) => {
    const selected = Array.from(e.target.files || []);
    if(selected.length === 0) return;
    setStatus('Processing uploads...');
    setInfo('Reading files — please wait');
    for(const f of selected){
      try{
        log('Reading', f.name);
        const info = await analyzeFile(f);
        files.push({ file: f, pages: info.pages, bytes: info.bytes });
        log('Added', f.name, 'pages', info.pages);
      }catch(err){
        log('Failed to read', f.name, err.message || err);
      }
    }
    setStatus('Ready');
    setInfo(`${files.length} file(s) loaded`);
    refreshFileList();
    // reset input so same file can be reselected if needed
    fileInput.value = '';
  });

  // Merge functionality
  mergeBtn.addEventListener('click', async () => {
    if(files.length < 1){
      alert('Please upload at least one PDF to merge.');
      return;
    }
    setStatus('Merging PDFs...');
    setInfo('Merging — this happens in your browser memory.');
    log('Merge started', files.map(f=>f.file.name));
    try{
      const mergedPdf = await PDFDocument.create();
      for(const fobj of files){
        const src = await PDFDocument.load(fobj.bytes);
        const srcPages = await mergedPdf.copyPages(src, src.getPageIndices());
        srcPages.forEach(p => mergedPdf.addPage(p));
        log('Appended', fobj.file.name, 'pages', fobj.pages);
      }
      const mergedBytes = await mergedPdf.save();
      const blob = new Blob([mergedBytes], { type: 'application/pdf' });
      const filename = `merged_${Date.now()}.pdf`;
      downloadBlob(blob, filename);
      setStatus('Merge complete');
      setInfo(`Merged ${files.length} file(s) — downloaded ${filename}`);
      log('Merge complete', filename);
    }catch(err){
      setStatus('Merge error');
      setInfo('Merge failed — see log');
      log('Merge error', err.message || err);
      alert('Merge failed: ' + (err.message || err));
    }
  });

  // Split functionality
  function selectForSplit(index){
    // show preview and set selected index on UI (simple)
    const fobj = files[index];
    if(!fobj) return;
    previewArea.innerHTML = '';
    const title = document.createElement('div'); title.className='file-meta'; title.textContent = fobj.file.name;
    const meta = document.createElement('div'); meta.className='file-small'; meta.textContent = `${fobj.pages} pages • ${(fobj.file.size/1024/1024).toFixed(2)} MB`;
    previewArea.appendChild(title); previewArea.appendChild(meta);
    // create quick page markers
    const pagesBox = document.createElement('div'); pagesBox.style.display='grid'; pagesBox.style.gridTemplateColumns='repeat(auto-fit, minmax(60px, 1fr))'; pagesBox.style.gap='6px'; pagesBox.style.marginTop='8px';
    for(let i=0;i<fobj.pages;i++){
      const btn = document.createElement('button'); btn.textContent = (i+1);
      btn.addEventListener('click', ()=> {
        rangeFrom.value = i+1; rangeTo.value = i+1;
        splitMode.value = 'range';
        rangeInputs.style.display = 'flex';
      });
      pagesBox.appendChild(btn);
    }
    previewArea.appendChild(pagesBox);
    // store selected index for split operation
    previewArea.dataset.selectedIndex = index;
    setInfo(`Selected "${fobj.file.name}" for splitting`);
  }

  splitMode.addEventListener('change', ()=> {
    if(splitMode.value === 'range'){
      rangeInputs.style.display = 'flex';
    } else rangeInputs.style.display = 'none';
  });

  splitBtn.addEventListener('click', async ()=>{
    const selIdx = previewArea.dataset.selectedIndex;
    if(selIdx == null){
      alert('Select a file first (click Select beside the file).');
      return;
    }
    const fobj = files[selIdx];
    if(!fobj) return;
    generatedFiles = []; // reset
    setStatus('Splitting PDF...');
    setInfo('Working — generating files in browser memory');
    log('Split start', fobj.file.name, 'mode', splitMode.value);
    try{
      const srcPdf = await PDFDocument.load(fobj.bytes);
      const total = srcPdf.getPageCount();
      if(splitMode.value === 'pages'){
        // produce single-page PDFs
        for(let i=0;i<total;i++){
          const outPdf = await PDFDocument.create();
          const [copied] = await outPdf.copyPages(srcPdf, [i]);
          outPdf.addPage(copied);
          const bytes = await outPdf.save();
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const fname = `${stripExt(fobj.file.name)}_page_${i+1}.pdf`;
          generatedFiles.push({ blob, name: fname });
          log('Generated page', i+1);
        }
        setInfo(`Created ${generatedFiles.length} single-page PDF(s).`);
      } else {
        // range extraction
        const from = parseInt(rangeFrom.value,10);
        const to = parseInt(rangeTo.value,10);
        if(!from || !to || from < 1 || to < from || to > total){
          alert(`Invalid range. Pages available: 1-${total}`);
          return;
        }
        const indices = [];
        for(let p=from-1;p<=to-1;p++) indices.push(p);
        const outPdf = await PDFDocument.create();
        const copied = await outPdf.copyPages(srcPdf, indices);
        copied.forEach(pg=> outPdf.addPage(pg));
        const bytes = await outPdf.save();
        const blob = new Blob([bytes], { type: 'application/pdf' });
        const fname = `${stripExt(fobj.file.name)}_pages_${from}-${to}.pdf`;
        generatedFiles.push({ blob, name: fname });
        setInfo(`Created extracted PDF: ${fname}`);
        log('Extracted range', from, to);
      }
      setStatus('Split complete');
      // auto-download first file, but also keep downloadAll available
      if(generatedFiles.length === 1){
        downloadBlob(generatedFiles[0].blob, generatedFiles[0].name);
        setInfo(`Downloaded ${generatedFiles[0].name}`);
      } else if(generatedFiles.length > 1){
        // download first to give instant feedback, let user click download all for rest
        downloadBlob(generatedFiles[0].blob, generatedFiles[0].name);
        setInfo(`Created ${generatedFiles.length} files. First downloaded. Use "Download All" to get the rest as zip (client-side).`);
      }
    }catch(err){
      log('Split error', err.message || err);
      setStatus('Split failed');
      setInfo('Split failed — see logs');
      alert('Split failed: ' + (err.message || err));
    }
  });

  downloadAllBtn.addEventListener('click', async ()=>{
    if(!generatedFiles || generatedFiles.length === 0){
      alert('No generated files to download. Run Split first.');
      return;
    }
    // create a zip client-side? to keep deps minimal we can sequentially trigger downloads
    // Better: package into a single zip using JSZip — but to avoid extra library we will prompt sequential downloads
    setInfo('Downloading all generated files (sequentially)...');
    for(const f of generatedFiles){
      await new Promise(res => {
        downloadBlob(f.blob, f.name);
        // small delay so browser handles downloads
        setTimeout(res, 600);
      });
    }
    setInfo('All files downloaded (or browser prompted).');
  });

  // helpers
  function stripExt(name){ return name.replace(/\.[^/.]+$/, ""); }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    log('Triggered download', filename);
  }

  function clearAll(){
    if(!confirm('Clear all uploaded files?')) return;
    files = []; generatedFiles = [];
    refreshFileList();
    previewArea.innerHTML = '';
    setStatus('Idle'); setInfo('Cleared');
    log('Cleared all files');
  }

  clearBtn.addEventListener('click', clearAll);

  // initial UI state
  setStatus('Idle'); setInfo('Upload PDFs to get started');
  refreshFileList();
  log('PDF Merger & Splitter initialized (pdf-lib loaded)', typeof PDFDocument !== 'undefined' ? 'pdf-lib ready' : 'pdf-lib missing');
})();
</script>
</body>
</html>
